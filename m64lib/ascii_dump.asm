; ¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤

    include binpath.inc

    .code

; ¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤

ascii_dump proc lpsrc:QWORD,lpbuf:QWORD,lnsrc:QWORD

    lea rdx, StringTable
    xor r11, r11                    ; line length counter

    mov rcx, lpsrc
    add rcx, lnsrc

    mov r10, lpsrc
    mov r9, lpbuf

    mov DWORD PTR [r9], 0D202020h   ; 3 space padding for alignment + CR
    add r9, 4
    mov DWORD PTR [r9], 2062640Ah   ; LF + "db "
    add r9, 4

    jmp adst

; ¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤

  align 16
  pre:
    mov BYTE PTR [r9-1], 13         ; overwrite comma with CR
    mov DWORD PTR [r9], 2062640Ah   ; write 4 bytes to maintain alignment
    add r9, 4
    xor r11, r11                    ; zero character count
  adst:
    movzx rax, BYTE PTR [r10]
    add r10, 1
    cmp r10, rcx                    ; test exit condition
    jg trimit
    mov rax, [rdx+rax*4]
    mov [r9], rax
    add r9, 4

    cmp r11, 15                     ; test character count per line
    je pre                          ; jump on less common choice
    add r11, 1
    jmp adst

; ¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤=÷=¤

  ; -----------------------------------------
  ; right trim any characters that are not
  ; decimal numbers, "0" to "9"
  ; -----------------------------------------
  trimit:
    sub r9, 1
  tloop:
    cmp BYTE PTR [r9], "0"
    jl albl
    cmp BYTE PTR [r9], "9"
    jg albl
    jmp lastbye
  albl:
    sub r9, 1
    jmp tloop

  lastbye:
    mov BYTE PTR [r9+1], 0          ; write terminator

    sub r9, lpbuf
    mov rax, r9                     ; return the uncompacted written length

    ret

  align 16
  StringTable:
    db 32,32,48,44,32,32,49,44,32,32,50,44,32,32,51,44,32,32,52,44,32,32,53,44,32,32,54,44,32,32,55,44
    db 32,32,56,44,32,32,57,44,32,49,48,44,32,49,49,44,32,49,50,44,32,49,51,44,32,49,52,44,32,49,53,44
    db 32,49,54,44,32,49,55,44,32,49,56,44,32,49,57,44,32,50,48,44,32,50,49,44,32,50,50,44,32,50,51,44
    db 32,50,52,44,32,50,53,44,32,50,54,44,32,50,55,44,32,50,56,44,32,50,57,44,32,51,48,44,32,51,49,44
    db 32,51,50,44,32,51,51,44,32,51,52,44,32,51,53,44,32,51,54,44,32,51,55,44,32,51,56,44,32,51,57,44
    db 32,52,48,44,32,52,49,44,32,52,50,44,32,52,51,44,32,52,52,44,32,52,53,44,32,52,54,44,32,52,55,44
    db 32,52,56,44,32,52,57,44,32,53,48,44,32,53,49,44,32,53,50,44,32,53,51,44,32,53,52,44,32,53,53,44
    db 32,53,54,44,32,53,55,44,32,53,56,44,32,53,57,44,32,54,48,44,32,54,49,44,32,54,50,44,32,54,51,44
    db 32,54,52,44,32,54,53,44,32,54,54,44,32,54,55,44,32,54,56,44,32,54,57,44,32,55,48,44,32,55,49,44
    db 32,55,50,44,32,55,51,44,32,55,52,44,32,55,53,44,32,55,54,44,32,55,55,44,32,55,56,44,32,55,57,44
    db 32,56,48,44,32,56,49,44,32,56,50,44,32,56,51,44,32,56,52,44,32,56,53,44,32,56,54,44,32,56,55,44
    db 32,56,56,44,32,56,57,44,32,57,48,44,32,57,49,44,32,57,50,44,32,57,51,44,32,57,52,44,32,57,53,44
    db 32,57,54,44,32,57,55,44,32,57,56,44,32,57,57,44,49,48,48,44,49,48,49,44,49,48,50,44,49,48,51,44
    db 49,48,52,44,49,48,53,44,49,48,54,44,49,48,55,44,49,48,56,44,49,48,57,44,49,49,48,44,49,49,49,44
    db 49,49,50,44,49,49,51,44,49,49,52,44,49,49,53,44,49,49,54,44,49,49,55,44,49,49,56,44,49,49,57,44
    db 49,50,48,44,49,50,49,44,49,50,50,44,49,50,51,44,49,50,52,44,49,50,53,44,49,50,54,44,49,50,55,44
    db 49,50,56,44,49,50,57,44,49,51,48,44,49,51,49,44,49,51,50,44,49,51,51,44,49,51,52,44,49,51,53,44
    db 49,51,54,44,49,51,55,44,49,51,56,44,49,51,57,44,49,52,48,44,49,52,49,44,49,52,50,44,49,52,51,44
    db 49,52,52,44,49,52,53,44,49,52,54,44,49,52,55,44,49,52,56,44,49,52,57,44,49,53,48,44,49,53,49,44
    db 49,53,50,44,49,53,51,44,49,53,52,44,49,53,53,44,49,53,54,44,49,53,55,44,49,53,56,44,49,53,57,44
    db 49,54,48,44,49,54,49,44,49,54,50,44,49,54,51,44,49,54,52,44,49,54,53,44,49,54,54,44,49,54,55,44
    db 49,54,56,44,49,54,57,44,49,55,48,44,49,55,49,44,49,55,50,44,49,55,51,44,49,55,52,44,49,55,53,44
    db 49,55,54,44,49,55,55,44,49,55,56,44,49,55,57,44,49,56,48,44,49,56,49,44,49,56,50,44,49,56,51,44
    db 49,56,52,44,49,56,53,44,49,56,54,44,49,56,55,44,49,56,56,44,49,56,57,44,49,57,48,44,49,57,49,44
    db 49,57,50,44,49,57,51,44,49,57,52,44,49,57,53,44,49,57,54,44,49,57,55,44,49,57,56,44,49,57,57,44
    db 50,48,48,44,50,48,49,44,50,48,50,44,50,48,51,44,50,48,52,44,50,48,53,44,50,48,54,44,50,48,55,44
    db 50,48,56,44,50,48,57,44,50,49,48,44,50,49,49,44,50,49,50,44,50,49,51,44,50,49,52,44,50,49,53,44
    db 50,49,54,44,50,49,55,44,50,49,56,44,50,49,57,44,50,50,48,44,50,50,49,44,50,50,50,44,50,50,51,44
    db 50,50,52,44,50,50,53,44,50,50,54,44,50,50,55,44,50,50,56,44,50,50,57,44,50,51,48,44,50,51,49,44
    db 50,51,50,44,50,51,51,44,50,51,52,44,50,51,53,44,50,51,54,44,50,51,55,44,50,51,56,44,50,51,57,44
    db 50,52,48,44,50,52,49,44,50,52,50,44,50,52,51,44,50,52,52,44,50,52,53,44,50,52,54,44,50,52,55,44
    db 50,52,56,44,50,52,57,44,50,53,48,44,50,53,49,44,50,53,50,44,50,53,51,44,50,53,52,44,50,53,53,44

ascii_dump endp

; ¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤¤

    end
